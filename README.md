# Infrastructure for patater.com

## Why?

I like flat, vanilla stacks. I don't like learning a DSL for scripts when
scripts themselves will do. I minimize layers of complexity. I build my own
jails to minimize baggage and to understand what I'm running, avoiding tools
that abstract away all the details (at least so I know how to debug when things
inevitably go wrong). I depend only on stable, solid, well-maintained, proven
tech that is going to be around for a while. The fanciest stuff here is Let's
Encrypt, pf, and jails. Both pf and jails are very mature tech that's been
around for decades. You'll find no Elastic Chef Kubernetes Beanstalk Puppet
Ansible Dockers here, only minimal jails, and minimal cloud service
dependencies.

The main reason for this project is to code the infrastructure hosted by the
patater.com server.

## What is it?

The patater.com infrastructure is a collection of FreeBSD jails, roughly one
per subdomain of my site. There are jails for many functions.

| Subdomain | Purpose |
| --------- | ------- |
| www       | web hosting |
| irc       | znc |
| sftp      | sftp servin' |
| ssh       | ssh and tmux console |

There are also a number of nullfs mounts shared among the jails.

| Name | Purpose | Mounted-by |
| ---- | ------- | ---------- |
| www-data | Files for serving web pages. htpasswd. | www (ro) |
| ssl-keys | Keys for subdomains. Written to by www via Let's Encrypt. | www (rw), irc (ro) |
| irc-data | Logs from znc. | irc |
| sftp-data | Data for SFTP. | sftp |
| sftp-keys | Authorized keys for SFTP. | sftp |
| ssh-keys | Authorized keys for SSH. | ssh |

Let's Encrypt is used to automatically obtain and renew certificates for each
subdomain jail. This functionality is implemented by the www jail.

The `setup.sh` script builds and deploys each jail.

## Requirements

The website is a static site, generated by jekyll.

To generate the web site, one requires 'bundler'
 - Make sure to use ruby 2.x.x or higher
 - gem install bundler

## Ideas

The www subdomain jail could be comprised of multiple images: one running nginx
as reverse proxy over a jail-only network to multiple other jails, one per web
site (or vhost). This would provide some isolation between vhosts better than
what we have now. Only the reverse proxy nginx jail would expose ports on the
host (80 and 443). This may complicate proving subdomain ownership for Let's
Encrypt.

If we could redirect a subset (or all) traffic incoming on the host to a jail
based on the subdomain, that would prove useful. For instance, we could easily
use standalone verification with Let's Encrypt. We could also trivially host
different web sites (without vhosts); this makes jails more portable. We could
host multiple XMPP servers on the default ports, picking the server based on
the subdomain. Implementing this sort of capability smells like a host firewall
configuration. This probably requires multiple IP addresses on the host, though
(one per subdomain).

While we'd like separate certificates for each subdomain, keeping subdomain
keys private in subdomain jails (without sharing volumes), for now, we'll have
the www jail obtain keys for all subdomains into a named volume. We do this
because Let's Encrypt verification requires publicly available port 80 or 443
on the requesting computer. We can't have each jail request its own certificate
because each jail can't expose 80 on the host: 80 on the host can only go to
one jail (for now).

## Testing Locally

To test the web server, which only serves up vhosts, edit your /etc/hosts file
to point patater.com to 127.0.0.1. https won't work, unless you have a valid
cert for patater.com stored in www-data.
