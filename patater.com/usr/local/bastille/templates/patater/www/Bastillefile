PKG nginx py37-certbot
OVERLAY etc
OVERLAY usr
CMD mkdir /usr/local/www/patater.com
FSTAB /www/patater.com usr/local/www/patater.com nullfs ro 0 0
FSTAB /www/letsencrypt usr/local/etc/letsencrypt nullfs rw 0 0
SYSRC nginx_enable=YES
SYSRC blacklistd_enable=YES
SERVICE blacklistd start
CMD openssl dhparam -out /usr/local/etc/nginx/dhparams.pem 2048
RDR tcp 80 80
RDR tcp 443 443

# We need to create an certificate so that nginx will start up without
# complaining about missing a pem. We can do this by adding a dummy self-signed
# private key pem, or using the certbot standalone authenticator.
CMD certbot certonly --standalone -d www.patater.net -d patater.net -m certbot@patater.net --agree-tos --no-eff-email
CMD certbot certonly --standalone -d irc.patater.net -m certbot@patater.net --agree-tos --no-eff-email

SERVICE nginx restart

# Then we need to change the authenticator back to webroot, so we don't need to
# turn off the web server every time we want to renew the certificate. We can
# do this by forcing a renewal with the certbot webroot authenticator.
CMD certbot certonly --cert-name www.patater.net --force-renewal -a webroot -w /usr/local/www/all/htdocs
CMD certbot certonly --cert-name irc.patater.net --force-renewal -a webroot -w /usr/local/www/all/htdocs
